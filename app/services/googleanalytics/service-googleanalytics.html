<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-signals/iron-signals.html">

<dom-module id="service-googleanalytics">
    <template>
        <iron-signals on-iron-signal-track-page="trackPage" on-iron-signal-track-event="trackEvent"></iron-signals>
    </template>
    <script>
        Polymer({
            is: 'service-googleanalytics',
            properties: {
                scope: {
                    type: String,
                    observer: '_scopeReceived'
                }
            },
            listeners: {
                'track-event': 'trackEvent',
                'track-page': 'trackPage',
                'user-id-changed': 'userIDChanged'
            },
            _scopeReceived: function(scope) {
                scope = JSON.parse(scope);
                this.set('code', scope.code);
                if (scope.userId)
                    this.set(userId, scope.userId)
                ga('create', this.code, 'auto');
                this.trackPage();

            },
            created: function() {
                console.log('[Google Analytics] Generating tracker')
                this._analytics(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
            },
            _analytics: function(i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function() {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                    m = s.getElementsByTagName('link')[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            },

            trackEvent: function(e) {
                console.log('[Google Analytics] Tracking event...');
                //Add support for a non-interactin even that does not effect bounce rates - eg things that happen after a timeout
                //ga('send', 'event', 'category', 'action', {'nonInteraction': 1});
                ga('send', 'event', e.detail.category, e.detail.action, e.detail.label, e.detail.value);
            },
            trackPage: function(e) {
                console.log('[Google Analytics] Tracking page...');
                //Use set param, this way if we then send a subsequent event on the page it will be correctly associated with the same page
                if (e !== undefined && e.detail.path !== undefined) {
                    ga('set', 'page', e.detail.path);
                }
                ga('send', 'pageview');
            },
            userIDChanged: function(e) {
                ga('set', '&uid', this.userId);
            }
        });
    </script>
</dom-module>