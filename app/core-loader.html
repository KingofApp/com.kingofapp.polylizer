<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="core-loader">

  <template>

    <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
      }
    </style>

    <div id="container">
    </div>

  </template>

  <script>
    Polymer({

      is: 'core-loader',

      properties: {
        config: {
          type: String
        },
        path: {
          type: String,
          reflectToAttribute: true
        }
      },

      observers: [
        '_dataReceived(config,path)'
      ],

      _dataReceived: function(config, path) {
        // Convert config and path objects into JSON if needed
        try {
          this.config = JSON.parse(config);
          this.path = JSON.parse(path);
        } catch (e) { }

        // Prevent undefined / empty path
        if(this.path.path && this.path.path != ''){
          //Remove selected classes "selected"
          var items = this.shadowRoot.querySelectorAll('.selected');
          for (var i = 0; i < items.length; i++) {
            items[i].classList.remove("selected");
            items[i].classList.add("hidden");
          }
          
          // Path reduction to create container paths
          var first = '/' + this.path.path.split("/")[1];
          this.path.path = this.path.path.replace(first,'');
          this.path.prefix += first;

          // Only for elements found in the structure service
          if (this.config.modules[this.path.prefix] && this.config.modules[this.path.prefix].identifier) {
            console.log("[core-loader] Creating element.. " + this.config.modules[this.path.prefix].identifier);
            this._createElement(this.config.modules[this.path.prefix]);
          }
        }
      },

      _createElement: function(module) {
        var dynamicEl = this.shadowRoot.querySelector("module-" + module.identifier);
        var scope = JSON.stringify(module.scope);
        var config = JSON.stringify(this.get('config'));
        var path = JSON.stringify(this.path);

        if (!this.shadowRoot.querySelector("module-" + module.identifier)) {
          // If module not found create a new element
          dynamicEl = document.createElement("module-" + module.identifier);
        }

        // Create attributes
        dynamicEl.setAttribute("class", "selected");
        dynamicEl.setAttribute("scope", scope);
        dynamicEl.setAttribute("config", config);
        dynamicEl.setAttribute("path", path);

        if (!this.shadowRoot.querySelector("module-" + module.identifier)) {
          // If module not found has to be appended
          Polymer.dom(this.$.container).appendChild(dynamicEl);
        }

        this._importElement(module);
      },

      _importElement: function(module) {
        // Import dynamic htmls
        var resolvedPageUrl = this.resolveUrl(module.view);
        this.importHref(resolvedPageUrl, null, null, true);
      }

    });
  </script>

</dom-module>
