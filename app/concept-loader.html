<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="concept-loader">

  <template>

    <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
      }
    </style>

    <div id="container">
    </div>

  </template>

  <script>
    Polymer({

      is: 'concept-loader',

      properties: {
        config: {
          type: String
        },
        path: {
          type: String,
          reflectToAttribute: true
        }
      },

      observers: [
        '_dataReceived(config,path)'
      ],

      _dataReceived: function(config, path) {
        // Convert config and path objects into JSON if needed
        try {
          this.config = JSON.parse(config);
          this.path = JSON.parse(path);
        } catch (e) { }

        // Prevent undefined / empty path
        if(this.path.path && this.path.path != ''){
          //Remove selected classes "selected"
          var items = this.shadowRoot.querySelectorAll('.selected');
          for (var i = 0; i < items.length; i++) {
            items[i].classList.remove("selected");
            items[i].classList.add("hidden");
          }

          // Path reduction to create container paths
          var routes = this.path.path.split("/");
          var temp = '';
          for (var i = 1; i < routes.length; i++) {
            temp += '/' + routes[i];
            // Only for elements found in the structure service
            if (this.config.modules[temp] && this.config.modules[temp].identifier) {
              console.log("[concept-loader] Creating element.. " + this.config.modules[temp].identifier);
              this._createElement(this.config.modules[temp]);
            }
          }


        }
      },

      _createElement: function(module) {
        var dynamicEl = this.shadowRoot.querySelector("module-" + module.identifier);
        var scope = JSON.stringify(module.scope);
        var config = JSON.stringify(this.get('config'));
        var path = JSON.stringify(this.path);

        if (!this.shadowRoot.querySelector("module-" + module.identifier)) {
          // If module not found create a new element
          dynamicEl = document.createElement("module-" + module.identifier);
        }

        // Create attributes
        dynamicEl.setAttribute("class", "selected");
        dynamicEl.setAttribute("scope", scope);
        dynamicEl.setAttribute("config", config);
        dynamicEl.setAttribute("path", path);

        // This is used to reorder elements
        Polymer.dom(this.$.container).appendChild(dynamicEl);

        this._importElement(module);
      },

      _importElement: function(module) {
        // Import dynamic htmls
        var resolvedPageUrl = this.resolveUrl(module.view);
        this.importHref(resolvedPageUrl, null, null, true);
      }

    });
  </script>

</dom-module>
