<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="concept-loader.html">
<link rel="import" href="async-loader.html">
<link rel="import" href="service-loader.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-app">
    <template>
    <style>
       :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;
        display: block;
      }
    </style>

    <!-- Read structure.json -->
    <iron-ajax auto url="/data/structure.json" handle-as="json" last-response="{{jsondata}}"></iron-ajax>

    <!-- Router to detect page changes -->
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

    <!-- Initial module load
    <concept-loader config="[[config]]" path=[[path]]> </concept-loader> -->

    <async-loader
      config$   ="[[asyncConfig]]"
      modules$  ="[[asyncModules]]"
      services$ ="[[asyncServices]]"
      path$=[[path]]
      > </async-loader>    
    <!-- Initial service load -->
    <service-loader config="[[config]]"> </service-loader>

  </template>
    <script>
        Polymer({

            is: 'my-app',

            properties: {
                page: {
                    type: String,
                    reflectToAttribute: true
                },
                jsondata: {
                    type: Object,
                    observer: '_configReceived'
                }
            },

            observers: [
                '_routePageChanged(routeData.page)'
            ],

            _routePageChanged: function(page) {
                // Alter path object on `routeData.page` change
                this.path = {
                    "path": this.route.path,
                    "prefix": '',
                };
            },
            created: function() {
              console.log('CREATED');
            },

            ready: function() {
              console.log('READY');
            },

            _configReceived: function(response) {
              console.log('CONFIG RECEIVED')
                // Structure.json object received
                // var keys = [];
                // if (response) {
                //   key = Object.keys(response);
                //   this.config = response['config'];
                //   console.log(this.config);
                // }
                // var al = this.shadowRoot.querySelector('async-loader').config = (this.config);
                this.config        = response;
                this.asyncConfig   = response.config;
                this.asyncModules  = response.modules;
                this.asyncServices = response.services;



                this._loadIndex();
            },
            _loadIndex: function() {
                // Load index every time a structure.json object is loaded
                if (this.route.path == "/") {
                    this._delayPageLoad(this.config.config.index, 0);
                }
            },

            _delayPageLoad: function(page, timeout) {
                // Page load function with timeout
                var _this = this;
                setTimeout(function() {
                    _this.route.path = page;
                    _this._routePageChanged(page);
                }, timeout);
            }

        });
    </script>
</dom-module>
